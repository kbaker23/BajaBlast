<!DOCTYPE HTML>
<html style="height:100%;">
<script type="text/javascript">
    
    
var gm = {
	
    gameWidth: 0,
    gameHeight: 0,
    gameId: "",
    scaleHorizontal: 0,
    scaleVertical: 0,
    language: "english",
    font: null,
    fontTwisted: null,
    fontColor1: '#729CC7',
    fontColor2: '#010D1A',
    fontColor3: '#6DCCA6',
    fontColor4: '#274F79',
    fontColor5: '#857BCE',
    music: null,
    mute: false,
    level: 1,
    lives: 4,
    currentTask: 0,
    currentNumberOfTasks: 0,
    gameStarted: false,
    joinSent: false,
    gotNewGameData: false,
    orientated: false,
    playerCount: 2,
    maxPlayers: 12,
    debug: false
};
    
var music = [
    ["1-1", "1-2", "1-3", "1-4", "1-5", "1-6"],
    ["2-1", "2-2", "2-3", "2-4", "2-5", "2-6"],
    ["3-1"],
    ["4-1"],
    []
];
    
var musicSources = [
    [],
    [],
    [],
    [],
    []
];
    
var sfx = {
    buttonClick: null,
    whoosh: null,
    bossIntro: null,
    stinger1: null
}
    
//Classes
var taskData = {
    text: "",
    level: 0,
    size: "",
    twist: "",
    extra: "",
    wildCard: "",
    players: "",
    drinks: 0
};
    
var taskList = [
    [],
    [],
    [],
    [],
    []
];
    
var players = [
    "Jacob",
    "Nelson",
    "Paratore",
    "Kell Bell"
];

</script>
<head>
	<title>Twisted</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="chrome=1, IE=9">
	<meta name="format-detection" content="telephone=no">
	<meta name="HandheldFriendly" content="true" />
	<meta name="robots" content="noindex,nofollow" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="apple-mobile-web-app-title" content="Twisted">
	<meta name="viewport" content="initial-scale=1 maximum-scale=1 user-scalable=0 minimal-ui shrink-to-fit=no" />
	<link rel="apple-touch-icon" href="icons/icon.png">
    <link rel="stylesheet" type = "text/css" href = "css/fontLoader.css">
	<link rel="stylesheet" href="css/stylesheet.css" type="text/css" charset="utf-8" />
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon" />
	<script src="src/phaser.min.js"></script>
	<script src="src/Boot.js"></script>
	<script src="src/Preloader.js"></script>
	<script src="src/Gameplay.js"></script>
    <script src="src/Manager.js"></script>
    <script src="src/Waterfall.js"></script>
    <script src="src/LimeRace.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="js/phaser-virtual-joystick.min.js" type="text/javascript"></script>
    <script src="js/phaser-input.min.js"></script>
</head>
<body id = "gameBody">
    
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script type="text/javascript">
        const sock = new SockJS('http://the-twisted-game.herokuapp.com/api');
        sock.onopen = function(){
            
            //Create a game
            const to_send = JSON.stringify({event: 'createGame', data: {name: 'game', settings: {tasksPerLevel: 10, size: 5}}});
	       sock.send(to_send);
            
        }
        sock.onmessage = function(msg){
            
            //For create game
            const data = JSON.parse(msg.data);
            
            console.log(msg.data);
            
            if (gm.gameId == "") {
                //Just created a game
                gm.gameId = "" + data.data.gameid;
                //sendJoinGame();
                return;
            }
            else if (!gm.gameStarted){
                console.log("started" + msg.data);
                //Start the game
                gm.gameStarted = true;
                sock.send(JSON.stringify({event: 'startGame', data: {gameid: gm.gameId}}));
            }
            else if (data.data != null && data.data.first != null){
                //Set can start game
                gm.gotNewGameData = true;
                
                //Got the data for the gameplay, fill in task data array
                taskList[0] = data.data.first;
                shuffle(taskList[0]);
                taskList[1] = data.data.second;
                shuffle(taskList[1]);
                taskList[2] = data.data.third;
                shuffle(taskList[2]);
                taskList[3] = data.data.fourth;
                shuffle(taskList[3]);
                taskList[4] = data.data.end;
            }
        }
        sock.onheartbeat = function(){
            //console.log("heartbeat");
        }
        sock.onclose = function(){
            //console.log('close');
        }
        
        //Send to start and then join a game
        function sendJoinGame() {
            console.log(players);
            for (var i = 0; i < players.length; i++) {
                if (players[i] == "") {
                    sock.send(JSON.stringify({event: 'joinGame', data: {gameid: gm.gameId, player: {name: "Player " + (i + 1)}}}));
                }
                else {
                    sock.send(JSON.stringify({event: 'joinGame', data: {gameid: gm.gameId, player: {name: players[i]}}}));
                }
            }
            gm.joinSent = true;
        }
    </script>
    
    <div id="game"style="height:100%;"></div>
	<div id="orientation"></div>
    
<script type="text/javascript">

(function () {
    
    //Init game
    gm.gameWidth = 1920;
    gm.gameHeight = 1080;
    gm.scaleHorizontal = gm.gameWidth / 3000;
    gm.scaleVertical = gm.gameHeight / 3000;
    gm.language = "english";
    gm.font = "40px Witless";
    gm.fontTwisted = gm.font;//"40px Seattle Avenue";
    var game = new Phaser.Game(gm.gameWidth, gm.gameHeight, Phaser.CANVAS, 'game');

	//States
	game.state.add('Boot', BasicGame.Boot);
	game.state.add('Preloader', BasicGame.Preloader);
	game.state.add('Gameplay', BasicGame.Gameplay);
	game.state.start('Boot');

})();
</script>

</body>
</html>